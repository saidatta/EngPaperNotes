

_Chapter 3 supplement for â€œPromenade: A Tour of Filesystems & Directoriesâ€_

> **Audience**â€‚Kernel / RE engineers building custom mounters, fuzzers, or Gatekeeper-bypass PoCs.  
> **Coverage**â€‚DiskImages.framework stack, in-kernel structures, compression & signatures, Developer Disk Image (DDI) path, and attack surface.

---

### 1 Â· DiskImages Architecture (â€œstack viewâ€)

mermaid

CopyEdit

`graph TD A[Finder / open(1) / hdiutil / hdiâ€‹k] -->|LaunchServices| B(DiskImageMounter.app) B -->|XPC| C[diskimages-helper] C -->|IOKit<br>IOServiceOpen("IOHDIXController")| D[IOHDIXController.kext] D --> E[Virtual block device (diskXsY)] E -->|VFS| F[mount_*  â†’ HFS+/APFS/â€¦]`

- **DiskImageMounter.app**Â â€“ sandboxed GUI/XPC front-end.
    
- **diskimages-helper**Â â€“ runs withÂ `com.apple.private.diskimages`Â entitlement; performs attach/detach.
    
- **IOHDIXController.kext**Â â€“ creates anÂ **on-the-fly block device**Â (DevMajor = 14).
    
- Optional helperÂ **`hdiejectd`**Â (not in fig) sends notifications & cleans up.
    

---

### 2 Â· Formats & Containers

|Abbrev|CFBundle identifier|Notes|
|---|---|---|
|**UDIF**|`com.apple.driver.DiskImages`|Base format (`.dmg`)|
|**UDZO**|_FileCompression ADC_|zlib/gzip compressed|
|**UDCO**|_FileCompression UDCO_|ADC (deflate64)|
|**UDZO (bzip2)**|`...DiskImages.FileBackingStore`|`.dmg`Â â€œcompressed (bzip2)â€|
|**ULFO**|LZFSE (macOS 10.11+)|High-ratio LZ77 + ANS|
|**UDSP**|Sparse bundle (`.sparseimage`)|Resizable, multiple bands|
|**UDRW**|Read-write image|Writable when attached|
|**Crypto (1/2)**|`...DiskImages.CryptoEncoding`|AES-128/256 CBC + PBKDF2|
|**RAMBacking**|`...DiskImages.RAMBackingStore`|tmpfs-style ramdisk|

`hdiutil convert -format <fmt>`Â freely converts between them.

---

### 3 Â· On-Disk Anatomy

#### 3.1 TheÂ **koly trailer**Â (512 B, last block)

c

CopyEdit

`typedef struct {            /* Listing 3-7 */     char     Signature[4];   // "koly"     uint32_t version;        // 4     uint32_t headerSize;     // 512     uint32_t flags;     uint64_t dataForkOffset; // 0 for UDIF     uint64_t dataForkLength; // expanded size     uint64_t rsrcForkOffset; // legacy, rarely used     uint64_t rsrcForkLength;     uint32_t segmentNumber;  // always 1 for UDIF     uint32_t segmentCount;     uuid_t   segmentID;      // for segmented images     uint32_t dataChecksumType;   // e.g. CRC32     uint32_t dataChecksumSize;     uint32_t dataChecksum[32];     uint64_t xmliOffset;     // plist     uint64_t xmliLength;     uint32_t reserved[64];     uint64_t sigOffset;      // *detached* code signature     uint64_t sigLength;     uint8_t  reserved2[40];     uint32_t masterChecksumType;     uint32_t masterChecksumSize;     uint32_t masterChecksum[32];     uint32_t imageVariant;   // 1 = UDIF     uint64_t sectorCount;    // uint64 sectors when mounted     uint32_t reserved3[3]; } koly_block_t;`

_Everything before the trailer isÂ **data fork**; trailer is read first to discover XML plist andÂ `blkx`._

---

#### 3.2Â Â `resource-fork`Â â†’ plist

xml

CopyEdit

`<dict>   <key>blkx</key>   <array>     <dict> â€¦ block map for PARTITION 0 â€¦ </dict>     <dict> â€¦ block map for PARTITION 1 â€¦ </dict>   </array>   <key>plist</key>   <array>     <dict>  GPT Header / EFI System  â€¦ </dict>     â€¦   </array> </dict>`

- EachÂ **blkx**Â entry encodesÂ _compressed blocks_Â (Listing 3-9/3-10).
    
- Apple extended SimPListIC format â€“ still parseable withÂ `CFPropertyList`Â in user land.
    

##### Block table (`blkx_block_table`)

c

CopyEdit

`typedef struct {     uint32_t mish_magic;      // "mish" (bwl2AAAA, base64)     uint32_t infoVersion;     // 1     uint64_t firstSector;     uint64_t numSectors;     uint64_t dataStart;       // file offset of first compressed block     uint32_t decomprBuf;      // size hint     uint32_t blockDescriptor; // always 0x1000     uint32_t checksumType;    // 0 (CRC32) / â€¦     uint32_t checksumSize;    // len     uint32_t numBlocks;     blkx_block_entry_t blocks[]; } blkx_block_table;`

##### Per-block entry (`blkx_block_entry_t`)

c

CopyEdit

`typedef enum {   COMPRESSION_RAW   = 0x00000001,   COMPRESSION_ADC   = 0x00000004, // zlib (UDCO)   COMPRESSION_ZLIB  = 0x00000005, // UDZO   COMPRESSION_BZIP2 = 0x00000006,   COMPRESSION_LZFSE = 0x00000007, // ULFO } compression_type;  typedef struct {   compression_type blockType;   uint32_t  reserved;   uint64_t  firstSector;   uint64_t  numSectors;   uint64_t  compOffset;   // offset in .dmg   uint64_t  compLength;   // compressed length } blkx_block_entry_t;`

_Random access_: IOHDIXController seeks block, decompresses chunk, serves sectors to VFS.

---

### 4 Â· Kernel Components (Table 3-11 recap)

|Kext|Role|
|---|---|
|`com.apple.driver.DiskImages`|primary attach logic (parses koly)|
|`â€¦FileBackingStore`|loop-mount raw files|
|`â€¦RAMBackingStore`|createsÂ `/dev/rdiskX`Â ramdisks|
|`â€¦HTTPBackingStore`Â (macOS)|**remote**Â DMGs via HTTP/HTTPS (!)|
|`â€¦CryptoEncoding`Â (macOS)|bulk-AES + PBKDF2 key unwrap|
|`â€¦SparseDiskImage`Â (macOS)|banded sparse images|
|`â€¦UDIFDiskImage`Â (iOS/tvOS)|base format, limited variants|

> **Security note**Â â€” historically, malformed ADC/LZFSE blocks inÂ `IOHDIXController`Â led to LPE. Always fuzzÂ **each compression decoder**.

---

### 5 Â· Mount/Unmount Flow (Figure 3-6 text â†’ sequenced)

mermaid

CopyEdit

`sequenceDiagram     participant F as Finder / open(1)     participant L as LaunchServices     participant M as DiskImageMounter.app     participant H as diskimages-helper     participant K as IOHDIXController.kext     participant V as VFS      F->>L: LSOpen(<.dmg>)     L->>M: XPC open     M->>H: XPC attach <path>     H->>K: IOServiceOpen("IOHDIXController")     H->>K: IOConnectCallStructMethod(kAttach, koly + blkx)     K-->>H: dev node /dev/diskXsY     H->>V: mount -t hfs / apfs / msdos     V-->>F: /Volumes/<label> ready`

_Detaching_Â reverses the calls viaÂ `IOConnectCallStructMethod(kDetach)`.

---

### 6 Â· Code Signatures & Trust

- SinceÂ **Darwin 15**Â the koly trailer may include anÂ **embedded CMS signature**  
    (`sigOffset`Â /Â `sigLength`).
    
- Gatekeeper / com.apple.security.quarantine appliesÂ **translocation**Â (macOS 12+).
    
- **DDI (DeveloperDiskImage.dmg)**Â for iOS/tvOS shipsÂ **detached signature**Â plusÂ **`.TrustCache`**Â loaded byÂ `AMFI.kext`â†’ allows Xcode tools to run adhoc-signed.
    

`trustcachectl dump /Developer/â€¦/DeveloperDiskImage.dmg.trustcache`Â â†’ inspect hashes.

---

### 7 Â· Hands-On Lab

#### 7.1 Create raw APFS image (Output 3-13)

bash

CopyEdit

`# Allocate 64 MB empty UDIF hdiutil create -megabytes 64 /tmp/test.dmg # Attach, partition, & format diskutil partitionDisk disk2 GPT APFS "Test_APFS" 100% hdiutil detach /tmp/test.dmg`

`hexdump -C /tmp/test.dmg | grep "EFI PART"`Â â†’ GPT header visible (no koly trailer).

#### 7.2 Convert + encrypt

bash

CopyEdit

`hdiutil convert /tmp/test.dmg -format UDZO -o test_z.dmg hdiutil convert test_z.dmg -format UDCF -encryption AES-256 \         -stdinpass -o secret.dmg   # prompt for passphrase on stdin`

#### 7.3 Bypass idea (research)

1. Craft UDIF withÂ **multiple blkx tables**, one benign, one overflow.
    
2. Trigger parsing via QuickLook â†’ code path in user-mode but shares libcompression.
    
3. Observe crash â†’ build fuzzer harness againstÂ `DiskImages.framework`.
    

---

### 8 Â· Reverse-Engineering Projects

|Project|Goal|Key APIs|
|---|---|---|
|**`libudif-rs`**|Pure Rust parser, no Apple libs; supports ULFO|`flate2`,Â `lzfse-rs`|
|**Kernel coverage fuzzer**|LeverageÂ `kmem-helper`Â to map IOHDIXController and fuzzÂ `IOConnectCallStructMethod`Â arguments|KPI:Â `mach_vm_write`,Â `kextstat`|
|**DDI trustcache generator**|Build custom trustcache to sideload unsigned tools on iOS dev-mode|`AppleMobileFileIntegrity`Â structs (`struct trust_chain`)|

---

### 9 Â· Defense & Hardening Checklist

- DisableÂ **remote HTTP disk images**Â if unused  
    `nvram boot-args=no_http_diskimages`Â _(undocumented patch via NVRAM)_.
    
- ForceÂ **signature validation**Â even on local mounts  
    `/System/Library/Frameworks/DiskImages.framework/Resources/defaults.plist`  
    â†’ setÂ `skip-verify`Â â†’Â `false`.
    
- MonitorÂ **IOHDIXController**Â IOConnect opens via EndpointSecurity ES_EVENT_TYPE_NOTIFY_OPEN.
    
- Gatekeeper quarantine + signed-by-Apple only (`com.apple.security.files.downloaded`Â attr).
    

---

### 10 Â· Quick Cheat-Sheet

|Task|CLI|
|---|---|
|List mounted disk images|`hdiutil info`|
|Attach without Finder UI|`hdiutil attach -nobrowse -readonly <dmg>`|
|Verify signature|`codesign -vvv <dmg>`|
|Dump blkx|`xxd -s $(($(stat -f %z <dmg>) - 512)) <dmg>`|
|Build sparse bundle|`hdiutil create -type SPARSEBUNDLE -fs APFS -size 10g my.sb`|

---

### ğŸ”š Key Takeaways

- **koly â†’ XML â†’ blkx**Â is the golden path: master these structs to parse or mutate anyÂ `.dmg`.
    
- Compression diversity (ADC, bzip2, LZFSE) = large attack surface inside both userland and IOHDIXController.kext.
    
- Detached signatures + TrustCache give Apple a way to ship dev images; the same channel is a potential RE playground.
    
- Tooling (`hdiutil`,Â `hdik`,Â `diskimages-helper`) is rich and scriptableâ€”ideal for fuzz harness orchestration.
    

Happy disassembling â€” and mount responsibly!